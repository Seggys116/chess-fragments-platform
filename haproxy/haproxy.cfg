global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

frontend http_front
    bind *:3000

    # Log all requests
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"

    # ACL to detect WebSocket upgrade requests
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket_path path_beg /api/local-agent/ws

    # Route WebSocket requests to local-agent-server
    use_backend websocket_back if is_websocket is_websocket_path

    # Default: route to Next.js web app
    default_backend web_back

backend web_back
    balance roundrobin
    option forwardfor
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    server web web:3000 check

backend websocket_back
    balance roundrobin
    # Forward real client IP
    option forwardfor
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    # Forward authentication headers from client to local-agent-server
    # These headers are needed for agent authentication
    http-request set-header X-Agent-Id %[req.hdr(X-Agent-Id)]
    http-request set-header X-Connection-Token %[req.hdr(X-Connection-Token)]
    # Enable WebSocket support
    option http-server-close
    timeout tunnel 3600s
    timeout server 3600s
    server localagent local-agent-server:9002 check
